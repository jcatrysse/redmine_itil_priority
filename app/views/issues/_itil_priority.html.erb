<% settings = RedmineItilPriority.settings_for(@project, @issue.tracker) %>
<% if settings %>
<style>
  .itil-priority { position:relative; display:inline-block; min-width:440px; min-height:50px;
                   background-color:#fffff3; padding:4px 6px; border:1px solid #eee; }
  .itil-priority label.inline { font-weight:normal; display:inline-block; width:60px; text-align:left; }
  .itil-priority select { width:150px !important; }
  .real-priority { box-sizing:border-box; width:100%; position:absolute; top:0; left:230px; height:100%; padding-top:1.4em; }
  .real-priority > .priority { position:absolute; top:1.4em; left:25px; font-size:110%; }
  #itil_priority_link.unlink { opacity:0.4; }
</style>
<% (1..3).each do |i| %>
  <% (1..3).each do |u| %>
    <% key = "priority_i#{i}_u#{u}" %>
    <%= content_tag(:span, settings[key], id: key, style: 'display:none;') %>
  <% end %>
<% end %>
<p id="itil_priority_field" data-new-record="<%= @issue.new_record? %>" data-default-priority="<%= IssuePriority.default.try(:id) %>">
<label><%= l(:field_priority) %></label>
<span class=itil-priority>
  <label class=inline><%= l(:field_urgency) %></label>
  <%= select_tag "issue[urgency_id]", options_for_select([["", ""]] + RedmineItilPriority.urgency_options(@project, @issue.tracker), @issue.urgency_id) %>
  <br>
  <label class=inline><%= l(:field_impact) %></label>
  <%= select_tag "issue[impact_id]", options_for_select([["", ""]] + RedmineItilPriority.impact_options(@project, @issue.tracker), @issue.impact_id) %>
  <%= hidden_field_tag 'issue[itil_priority_linked]', (@issue.impact_id && @issue.urgency_id) ? '1' : '0', id: 'itil_priority_linked' %>
  <span class=real-priority>
    <%= image_tag("stock_link.png", plugin: "redmine_itil_priority", id: "itil_priority_link", style: 'cursor:pointer;') %>
    <span class=priority>
      <%= select_tag "issue[priority_id]", options_for_select(@priorities.map { |p| [p.name, p.id] }, @issue.priority_id),
                     id: 'itil_issue_priority_id', disabled: !@issue.leaf?, style: 'display:none;' %>
      <%= content_tag :span, @issue.priority, id: "real-priority-display" %>
    </span>
  </span>
  </span>
</p>
<script>
$(function() {
  var $priority = $("#issue_priority_id").closest('p')
  $priority.replaceWith($("#itil_priority_field"))
  var $select = $("#itil_issue_priority_id")
  var $link = $("#itil_priority_link")
  var linked = $('#itil_priority_linked').val() !== '0'
  var defaultPriority = String($("#itil_priority_field").data('default-priority'))

  function recalculateItilPriority(impact, urgency) {
    var priority_id = $("#priority_i" + impact + "_u" + urgency).text()
    $select.val(priority_id)
    $("#real-priority-display").text($select.find("option:selected").text())
  }

  function setLinked(state) {
    linked = state
    $('#itil_priority_linked').val(linked ? '1' : '0')
    $link.toggleClass('unlink', !linked)
    if (linked) {
      $select.hide()
      $('#real-priority-display').show()
      syncPriority()
    } else {
      $select.show()
      $('#real-priority-display').hide()
    }
  }

  function syncPriority() {
    var impact = $("#issue_impact_id").val()
    var urgency = $("#issue_urgency_id").val()
    if (linked) {
      if (impact === '' || urgency === '') {
        $select.val(defaultPriority)
        $("#real-priority-display").text($select.find("option:selected").text())
      } else {
        recalculateItilPriority(impact, urgency)
      }
    }
  }

  $("#issue_urgency_id, #issue_impact_id").on("change", syncPriority)

  $link.on('click', function() {
    setLinked(!linked)
  })
  var isNew = $("#itil_priority_field").data('new-record')
  if (isNew && $("#issue_impact_id").val() === '' && $("#issue_urgency_id").val() === '') {
    outer:
    for (var i = 1; i <= 3; i++) {
      for (var u = 1; u <= 3; u++) {
        var span = $("#priority_i" + i + "_u" + u)
        if (span.text() === defaultPriority) {
          $("#issue_impact_id").val(i)
          $("#issue_urgency_id").val(u)
          setLinked(true)
          break outer
        }
      }
    }
  }

  syncPriority()
})
</script>
<% end %>
